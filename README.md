# 基于 STM32 的低功耗智能水表设计与实现
🧭 一、项目概述
----------------

本项目基于 STM32L 系列微控制器，设计并实现一款具备 **低功耗运行、脉冲采集、存储记录、NB-IoT 通信上报、远程阀控** 功能的智能水表系统。该系统适用于物联网远程抄表应用场景，支持平台数据对接与周期性流量统计。

* * *

🧩 二、系统架构图
----------------

```
+-------------------------------+
|         云端抄表平台         |
+-------------------------------+
            ↑↓ MQTT/HTTP
+-------------------------------+
|   NB-IoT 模块 (Quectel BC26) |
+-------------------------------+
            ↑ UART (AT指令)
+-------------------------------+
|       STM32 主控芯片         |
|  - 脉冲采集 (EXTI/TIM)       |
|  - RTC 定时唤醒              |
|  - Flash 存储数据            |
|  - 阀门控制 GPIO              |
+-------------------------------+
            ↑
     霍尔/干簧管水流传感器
```

* * *

🛠️ 三、主要功能模块及任务分解
-----------------

### 1️⃣ 脉冲采集模块

* 使用 `EXTI` 或 `TIM 输入捕获` 实现水流脉冲统计
    
* 通过定时器记录每分钟用水量（L/min）
    

### 2️⃣ 低功耗管理模块

* 利用 STM32 的 `Stop 模式` + `RTC 唤醒` 实现周期性唤醒（每1分钟）
    
* 睡眠期间关闭外设，进入超低功耗运行（<10uA）
    

### 3️⃣ 数据存储模块

* 使用 `Flash` 或 `EEPROM` 存储每日用水记录（日期 + 总用量）
    
* 支持掉电数据恢复机制
    
* 实现简单 wear leveling
    

### 4️⃣ 通信模块（NB-IoT）

* 控制 Quectel BC26 模块发送抄表数据到服务器
    
* 使用 `AT 指令 + UART` 通信
    
* 协议采用简化的 MQTT 或 HTTP JSON POST
    
* 支持远程平台发送“关阀/开阀”指令（平台下发 → MCU 控制 GPIO 驱动电磁阀）
    

### 5️⃣ 阀门控制模块

* 驱动电磁阀实现远程控制水路开关
    
* 考虑阀门堵转保护、电量不足禁止操作等安全机制
    

### 6️⃣ 故障检测与自恢复

* 阀门控制超时报警
    
* 通信失败重试策略（指数退避）
    
* Flash 写入失败 fallback 处理
    

* * *

📑 四、关键技术点
----------

| 技术方向 | 应用说明 |
| --- | --- |
| STM32L 低功耗 | Stop 模式、RTC 唤醒、PWR API |
| 脉冲采集 | GPIO 中断 / TIM 输入捕获 |
| NB-IoT 通信 | 串口 AT 指令、发送 JSON 数据 |
| Flash 日志记录 | 持久化存储每日水量数据 |
| 远程控制 | 云平台下发 MQTT / HTTP 指令解析 |
| 电磁阀驱动 | MOS 管驱动 + PWM 限流保护 |
| 软件架构 | 基于 FSM + 任务循环 或 FreeRTOS |

* * *

🔋 五、电源与功耗设计建议
--------------

* 使用锂电池 + LDO（或 DC-DC 转换）
    
* MCU 平均功耗目标 < 20uA（1次/分钟数据上传）
    
* 通信模块工作时峰值电流需 > 100mA，需电容补偿
    
* 加入欠压检测（PVD），电量不足时禁止开阀
    

* * *

📌 六、可选拓展功能（Bonus）
------------------

* NFC 近场设置表号或参数（用于安装调试）
    
* OLED 屏幕本地显示状态（调试可用）
    
* 配套 Web Dashboard 或串口调试工具
    
* 支持 M-Bus/LoRa 作为通信备选方式
    

* * *

📷 七、项目成果展示
-----------------

* 演示视频（上传平台）
    
* 本地日志打印（串口）
    
* 功耗测试数据（多功能表 + 睡眠电流实测）
    
* 云平台数据截图（HTTP POST / MQTT 上报）
    

* * *
